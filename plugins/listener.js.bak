// listener.js
import { db } from './db.js';

export async function trackMessage(m, conn) {
  if (!m.key.remoteJid.endsWith('@g.us')) return; // solo gruppi

  let chatId = m.key.remoteJid;
  let data = db.load();

  if (!data.gruppi[chatId]) {
    data.gruppi[chatId] = { nome: '', membri: 0, messaggi: 0 };
  }

  // incrementa i messaggi
  data.gruppi[chatId].messaggi++;

  try {
    // aggiorna info gruppo
    let meta = await conn.groupMetadata(chatId);
    data.gruppi[chatId].membri = meta.participants.length;
    data.gruppi[chatId].nome = meta.subject || chatId;
  } catch (e) {
    console.log("‚ùå Errore nel leggere i membri:", e);
  }

  // salva il db
  db.save(data);

  // log in console
  console.log(
    `üíæ Salvato gruppo: ${data.gruppi[chatId].nome || chatId}\n` +
    `   ‚Üí Messaggi: ${data.gruppi[chatId].messaggi}\n` +
    `   ‚Üí Membri: ${data.gruppi[chatId].membri}`
  );
}