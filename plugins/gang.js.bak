const gangRequests = {}; // Inviti in memoria
const gangData = {}; // Dati delle gang

let handler = async (m, { conn, command, text, usedPrefix }) => {
    const users = global.db.data.users;
    const user = users[m.sender];

    switch (command) {
        case 'creagang':
            await handleCreateGang(m, user, users, text, usedPrefix, conn);
            break;
        case 'invitogang':
            await handleGangInvite(m, user, users, text, usedPrefix, conn);
            break;
        case 'abbandonagang':
            handleLeaveGang(m, user, users);
            break;
        case 'caccialogang':
            handleKickFromGang(m, user, users);
            break;
        case 'infogang':
            handleGangInfo(m, user, users);
            break;
    }
};

// Creazione gang
const handleCreateGang = async (m, user, users, text, usedPrefix, conn) => {
    if (!text) throw `ðŸ”« Usa: ${usedPrefix}creagang <nome> <emoji>`;
    const [name, emoji] = text.split(' ');
    if (!name || !emoji) throw 'âŒ Inserisci nome e emoji!';
    if (user.gang) throw 'ðŸš« Sei giÃ  in una gang!';
    
    const gangId = generateGangId();
    gangData[gangId] = { name, emoji, leader: m.sender, members: [m.sender], createdAt: new Date().toISOString() };
    user.gang = { id: gangId, role: 'leader' };

    await conn.sendMessage(m.chat, {
        text: `ðŸŽŒ Gang creata: *${emoji} ${name} ${emoji}*\nðŸ‘‘ Capo: @${m.sender.split('@')[0]}\nUsa ${usedPrefix}invitogang @utente per invitare membri.`,
        mentions: [m.sender]
    });
};

// Invito gang
const handleGangInvite = async (m, user, users, text, usedPrefix, conn) => {
    if (!user.gang) throw 'ðŸš« Non sei in una gang!';
    if (user.gang.role !== 'leader') throw 'ðŸ”ª Solo il capo puÃ² invitare membri!';
    
    const mention = m.mentionedJid?.[0] || m.quoted?.sender;
    if (!mention) throw `ðŸ”« Tagga un utente con ${usedPrefix}invitogang @utente`;
    if (mention === m.sender) throw 'ðŸ¤¡ Non puoi invitare te stesso!';
    
    const target = users[mention];
    if (!target) throw 'ðŸš« Utente non trovato!';
    if (target.gang) throw 'ðŸš· Questo utente Ã¨ giÃ  in una gang!';
    if (gangRequests[mention]) throw 'â³ Invito giÃ  inviato!';

    const gangInfo = gangData[user.gang.id];
    gangRequests[mention] = { from: m.sender, gangId: user.gang.id, timeout: null };

    await conn.sendMessage(m.chat, {
        text: `ðŸ”« *INVITO GANG*\n\n@${m.sender.split('@')[0]} ti invita nella gang *${gangInfo.emoji} ${gangInfo.name} ${gangInfo.emoji}*.\nðŸ’€ Rispondi "accetta" o "rifiuta" entro 60 secondi!`,
        mentions: [mention, m.sender]
    });

    gangRequests[mention].timeout = setTimeout(() => {
        if (gangRequests[mention]) {
            conn.sendMessage(m.chat, { text: `âŒ› Invito per @${mention.split('@')[0]} scaduto.`, mentions: [mention] });
            delete gangRequests[mention];
        }
    }, 60000);
};

// Gestione messaggi prima del normale handler (accetta/rifiuta)
handler.before = async (m, { conn }) => {
    if (!(m.sender in gangRequests)) return;
    const req = gangRequests[m.sender];
    clearTimeout(req.timeout);

    const gangInfo = gangData[req.gangId];
    const inviter = req.from;
    const users = global.db.data.users;

    if (/^accetta$/i.test(m.text)) {
        gangInfo.members.push(m.sender);
        users[m.sender].gang = { id: req.gangId, role: 'member' };
        await conn.sendMessage(m.chat, {
            text: `ðŸŽŠ @${m.sender.split('@')[0]} Ã¨ entrato nella gang *${gangInfo.emoji} ${gangInfo.name} ${gangInfo.emoji}*! ðŸ”¥\nMembri: ${gangInfo.members.length}`,
            mentions: [m.sender]
        });
        delete gangRequests[m.sender];
    } else if (/^rifiuta$/i.test(m.text)) {
        await conn.sendMessage(m.chat, {
            text: `ðŸ’¢ @${m.sender.split('@')[0]} ha rifiutato l'invito.`,
            mentions: [m.sender]
        });
        delete gangRequests[m.sender];
    }
};

// Abbandona gang
const handleLeaveGang = (m, user, users) => {
    if (!user.gang) throw 'ðŸš« Non sei in nessuna gang!';
    const gangInfo = gangData[user.gang.id];

    if (user.gang.role === 'leader') {
        gangInfo.members.forEach(member => { if (users[member]) users[member].gang = null; });
        delete gangData[user.gang.id];
        return m.reply(`ðŸ’¥ Gang *${gangInfo.name}* sciolta!`, null, { mentions: [m.sender] });
    }

    gangInfo.members = gangInfo.members.filter(member => member !== m.sender);
    user.gang = null;
    m.reply(`ðŸ³ï¸ Hai lasciato la gang *${gangInfo.name}*`);
};

// Caccia membro
const handleKickFromGang = (m, user, users) => {
    if (!user.gang) throw 'ðŸš« Non sei in nessuna gang!';
    if (user.gang.role !== 'leader') throw 'ðŸ”ª Solo il capo puÃ² cacciare membri!';

    const mention = m.mentionedJid?.[0] || m.quoted?.sender;
    if (!mention) throw 'ðŸ”« Tagga il membro da cacciare!';
    if (!gangData[user.gang.id].members.includes(mention)) throw 'ðŸš· Utente non in gang!';
    
    gangData[user.gang.id].members = gangData[user.gang.id].members.filter(m => m !== mention);
    if (users[mention]) users[mention].gang = null;

    m.reply(`ðŸ”ª @${mention.split('@')[0]} cacciato dalla gang!`, null, { mentions: [mention] });
};

// Info gang
const handleGangInfo = (m, user, users) => {
    if (!user.gang) throw 'ðŸš« Non sei in nessuna gang!';
    const gangInfo = gangData[user.gang.id];

    const membersList = gangInfo.members.map(member => {
        const role = member === gangInfo.leader ? 'ðŸ‘‘ Capo' : 'ðŸ’€ Soldato';
        return `â€¢ @${member.split('@')[0]} (${role})`;
    }).join('\n');

    m.reply(`ðŸ”« *INFO GANG*\n*${gangInfo.emoji} ${gangInfo.name} ${gangInfo.emoji}*\nðŸ‘¥ Membri (${gangInfo.members.length}):\n${membersList}`, null, { mentions: gangInfo.members });
};

function generateGangId() { return Math.random().toString(36).substr(2,6).toUpperCase(); }

handler.command = ['creagang','invitogang','abbandonagang','caccialogang','infogang'];
handler.help = [
    'creagang <nome> <emoji> - Crea una nuova gang',
    'invitogang @utente - Invita un utente',
    'abbandonagang - Lascia la tua gang',
    'caccialogang @utente - Caccia un membro (solo capo)',
    'infogang - Mostra info sulla tua gang'
];

export default handler;